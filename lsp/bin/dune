(include_subdirs unqualified)

; get rid of this gross hack once dune has proper crunch support

(rule
 (with-stdout-to
  spec.ml
  (progn
   (echo "let _3_16 = {spec|")
   (echo "%{read:specifications/specification-3-16.md}")
   (echo "|spec}"))))

(rule
 (with-stdout-to
  metamodel_lsp.ml
  (progn
   (echo "let t () = Metamodel.t @@ Yojson.Safe.from_string {json|")
   (echo "%{read:metaModel.json}")
   (echo "|json}"))))

(executable
 (name gen)
 (modules gen)
 (libraries lsp_gen dyn stdune))

(test
 (name test_metamodel)
 (modules test_metamodel)
 (libraries stdune yojson lsp_gen)
 (deps metaModel.json)
 (action
  (run ./test_metamodel.exe %{deps})))

(library
 (name lsp_gen)
 (instrumentation
  (backend bisect_ppx))
 (modules :standard \ gen test_metamodel)
 (libraries stdune dyn pp yojson))
